{% extends 'base/base.html' %}
{% block title %}Your Cart{% endblock title %}
{% block maincontent %}

	{% if cartitems %}
		<div class="row border rounded-5 border-primary m-5 p-5">
			<div class="col-md-8">
				{% for item in cartitems %}
					<div class="card mb-3" style="max-width: 540px;">
						<div class="row g-0">
							<div class="col-md-4">
								<img src="{{item.food.image.url}}" class="img-fluid rounded-start"  style="height:180px; width:220px;">
							</div>
							<div class="col-md-8">
								<div class="card-body">
									<div class="d-flex justify-content-between">
										<div>
											<h5 class="card-title">{{item.food.name | title}}</h5>
											<p class="card-text">{{item.food.description | title}}</p>
										</div>
										<div>
											<a class="btn btn-danger" onclick="updateCart('delete_cart_item', {{item.food.id}})"><i class="fa-solid fa-trash"></i></a>
										</div>
									</div>
									<div class="d-flex justify-content-between text-center mt-4">
										<div class="border rounded">
											<h5 class="card-title border-bottom m-1">Price</h5>
											<h5 class="card-title">{{item.food.price | title}}</h5>
										</div>
										<div class="border rounded">
											<h5 class="card-title border-bottom m-1">Quantity</h5>
											<div class="d-flex">
												{% if item.quantity == 1 %}
													<a class="btn btn-danger" onclick="updateCart('delete_cart_item', {{item.food.id}})"><i class="fa-solid fa-trash"></i></a>
												{% else %}
													<a class="btn btn-warning" onclick="updateCart('decrease_cart', {{item.food.id}}, '{{item.food.name|cut:" "}}_quantity')"><i class="fa-solid fa-minus"></i></a>
												{% endif %}
												<h5 class="card-title mx-1" id="{{item.food.name|cut:" "}}_quantity">{{item.quantity}}</h5>
												<a class="btn btn-primary" onclick="updateCart('increase_cart', {{item.food.id}})"><i class="fa-solid fa-plus"></i></a>
											</div>
										</div>
										<div class="border rounded">
											<h5 class="card-title border-bottom m-1">Amount</h5>
											{% for item_name, amount in total_of_each_item.items %}
												{% if item_name == item.food.name %}
													<h5 class="card-title m-1 {{item_name|cut:" "}}_amount">{{amount}}</h5>
												{% endif %}
											{% endfor %}
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				{% endfor %}
			</div>
			<div class="col-md-4">
				<div class="card">
					<div class="card-body">
						<h3 class="border-bottom">The Total Amount of:</h3>
						<ul class="list-group">
							{% for item_name, amount in total_of_each_item.items %}
								<li class="list-group-item d-flex justify-content-between align-items-center border-0 px-0 pb-0">{{item_name}}
									<span class="{{item_name|cut:" "}}_amount">{{amount}}</span>
								</li>
							{% endfor %}
							<li class="list-group-item d-flex justify-content-between align-items-center border-0 border-top px-0 mb-3 mt-3">
								<strong>Total</strong>
								<strong id="total_amount">{{total_amount}}</strong>
							</li>
						</ul>
						<div class="d-grid">
							<form action="/checkout/" method="post" id="paypalform">
								{% csrf_token %}
								<input type="hidden" name="paymode" value="Online">
								<input type="hidden" name="paygate" value="Paypal">
								<div id="paypal-button-container"></div>
							</form>
							<form action="/checkout/" method="post" id="cashform">
								{% csrf_token %}
								<input type="hidden" name="paymode" value="Cash">
								<div class="d-grid">
									<input type="submit" class="btn btn-primary p-2 fw-semibold" value="Pay Cash On Delivery">
								</div>
							</form>
						</div>
					</div>
				</div>
				<h5 class="alert alert-warning text-center mt-3 p-2 border border-warning border-3">Note: You Can Collect Your Order from Canteen When <strong>Status</strong> is <strong>Packed</strong> in <a href="{% url 'my-orders' %}">My Orders</a> Page</h5>
			</div>
		</div>
		<div id="os"></div>
	{% else %}
		<h1 class="alert alert-info text-center mt-5">Your Cart is Empty</h1>
	{% endif %}
	
{% endblock maincontent %}

{% block update-cart-script %}
<script>
	function updateCart(task, f_id, quantity_check){
		console.log("button clicked", task, f_id)
		console.log("........", quantity_check, typeof(quantity_check))
		document.getElementById(quantity_check)
		const xhr = new XMLHttpRequest();
		xhr.open('GET', `http://127.0.0.1:8000/update-cart/${f_id}?name=${task}`, true)
		xhr.responseType = "json"
		xhr.onload = () => {
			if(xhr.status === 200){
				console.log(xhr.response)
				Object.keys(xhr.response.details_of_cart_item).forEach(function(key) {
					id_name = key.replaceAll(' ','') + "_quantity"
					document.getElementById(id_name).innerText = xhr.response.details_of_cart_item[key].quantity
					class_name = key.replaceAll(' ','') + "_amount"
					elements = document.getElementsByClassName(class_name)
					console.log(elements)
					for(element = 0; element < elements.length; element++){
						elements[element].innerText = xhr.response.details_of_cart_item[key].amount
					}
				});
				document.getElementById("total_amount").innerText = xhr.response.total_amount
			} else {
				console.log('no data recived')
			}
		};
		xhr.send();
	}
</script>
{% endblock update-cart-script %}

{% block payment-gateway %}
<script src="https://www.paypal.com/sdk/js?client-id=AdstVdkXtBT7eFeAKT1PuFTYmnm3a9HgAeyqXiJtxNKFQJav05K7ljkgv6e1EbefJo_crAAgYXsElPcf&currency=USD"></script>

    <script>
        // Render the PayPal button into #paypal-button-container
        paypal.Buttons({

            // Set up the transaction
            createOrder: function(data, actions) {
                return actions.order.create({
                    purchase_units: [{
                        amount: {
                            value: '{{total_amount}}'
                        }
                    }]
                });
            },

            // Finalize the transaction
            onApprove: function(data, actions) {
                return actions.order.capture().then(function(orderData) {
                    // Successful capture! For demo purposes:
                    // console.log('Capture result', orderData, JSON.stringify(orderData, null, 2));
                    var transaction = orderData.purchase_units[0].payments.captures[0];
                    alert('Transaction '+ transaction.status + ': ' + transaction.id + '\n\nOrder Placed Successfully' + '\nClick OK to Proceed Further');
					
					form = document.getElementById('paypalform')
					hidnInp = document.createElement("input")
					hidnInp.setAttribute('type', 'hidden')
					hidnInp.setAttribute('name', 'tn_id')
					hidnInp.setAttribute('value', transaction.id)
					form.appendChild(hidnInp)
					document.getElementById('paypalform').submit()
					
                    // Replace the above to show a success message within this page, e.g.
                    // const element = document.getElementById('paypal-button-container');
                    // element.innerHTML = '';
                    // element.innerHTML = '<h3>Thank you for your payment!</h3>';
                    // Or go to another URL:  actions.redirect('thank_you.html');
                });
            }


        }).render('#paypal-button-container');
    </script>
{% endblock payment-gateway %}